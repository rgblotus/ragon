services:
    etcd:
        container_name: neo-milvus-etcd
        image: quay.io/coreos/etcd:v3.5.18
        environment:
            - ETCD_AUTO_COMPACTION_MODE=revision
            - ETCD_AUTO_COMPACTION_RETENTION=1000
            - ETCD_QUOTA_BACKEND_BYTES=4294967296
            - ETCD_SNAPSHOT_COUNT=50000
        volumes:
            - etcd:/etcd
        command: >
            etcd
            -advertise-client-urls=http://etcd:2379
            -listen-client-urls http://0.0.0.0:2379
            --data-dir /etcd
        healthcheck:
            test: ['CMD-SHELL', 'etcdctl endpoint health || exit 1']
            interval: 5s
            timeout: 3s
            retries: 3
            start_period: 5s
        networks:
            - neo-network

    minio:
        container_name: neo-milvus-minio
        image: minio/minio:RELEASE.2024-12-18T13-15-44Z
        environment:
            MINIO_ACCESS_KEY: minioadmin
            MINIO_SECRET_KEY: minioadmin
        ports:
            - '9001:9001'
            - '9000:9000'
        volumes:
            - minio:/minio_data
        command: minio server /minio_data --console-address ":9001"
        healthcheck:
            test:
                ['CMD', 'curl', '-f', 'http://localhost:9000/minio/health/live']
            interval: 5s
            timeout: 3s
            retries: 3
            start_period: 5s
        networks:
            - neo-network

    milvus:
        container_name: neo-milvus-standalone
        image: milvusdb/milvus:v2.6.5-gpu
        command: ['milvus', 'run', 'standalone']
        security_opt:
            - seccomp:unconfined
        environment:
            ETCD_ENDPOINTS: etcd:2379
            MINIO_ADDRESS: minio:9000
            MQ_TYPE: woodpecker
        volumes:
            - milvus:/var/lib/milvus
        ports:
            - '19530:19530'
            - '9091:9091'
        deploy:
            resources:
                reservations:
                    devices:
                        - driver: nvidia
                          capabilities: ['gpu']
                          device_ids: ['0']
        depends_on:
            - etcd
            - minio
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://localhost:9091/healthz']
            interval: 10s
            timeout: 5s
            retries: 3
            start_period: 30s
        networks:
            - neo-network

# Correct volume declarations
volumes:
    etcd:
    minio:
    milvus:

# Shared network
networks:
    neo-network:
        external: true
